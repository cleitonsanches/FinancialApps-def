# Configuração do Nginx para duas instâncias (Produção e Testes)
# Substitua 'seu-ip' pelo IP real do servidor

server {
    listen 8080;
    server_name 92.113.32.118;

    # ============================================
    # INSTÂNCIA DE TESTES (deve vir PRIMEIRO)
    # ============================================
    
    # API de Testes - IMPORTANTE: deve vir ANTES de /test para não conflitar
    location /test/api/ {
        # Remover o prefixo /test antes de passar para a API
        rewrite ^/test/api/(.*)$ /api/$1 break;
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # API de Testes (sem barra final) - redirecionar para versão com barra
    location = /test/api {
        return 301 /test/api/;
    }

    # Arquivos estáticos do Next.js (testes) - IMPORTANTE: deve vir ANTES do /test
    location /test/_next {
        proxy_pass http://localhost:3003;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_valid 200 60m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    }

    # Frontend de Testes - deve vir DEPOIS de /test/api e /test/_next
    location /test/ {
        proxy_pass http://localhost:3003/test/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /test;
        proxy_cache_bypass $http_upgrade;
    }
    
    # Frontend de Testes (sem barra final) - redirecionar para versão com barra
    location = /test {
        return 301 /test/;
    }

    # ============================================
    # INSTÂNCIA DE PRODUÇÃO
    # ============================================
    
    # API de Produção - IMPORTANTE: deve vir DEPOIS de /test/api
    location /api/ {
        proxy_pass http://localhost:3001/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # API de Produção (sem barra final) - redirecionar para versão com barra
    location = /api {
        return 301 /api/;
    }

    # Frontend de Produção (raiz) - deve vir por último
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

