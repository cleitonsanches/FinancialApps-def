name: Deploy to VPS

on:
  push:
    branches:
      - main
    # Evitar deploy automÃ¡tico em cada push, apenas quando explicitamente necessÃ¡rio
    # Para ativar: descomente as linhas acima e comente o workflow_dispatch abaixo
  workflow_dispatch:
    # Permite deploy manual pelo GitHub Actions UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build API
        run: npm run build --workspace=apps/api

      - name: Build Web
        run: npm run build --workspace=apps/web

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            # Ir para o diretÃ³rio do projeto
            cd /var/www/FinancialApps-def
            
            # Fazer backup do banco de dados antes do deploy
            if [ -f database.sqlite ]; then
              cp database.sqlite database.sqlite.backup.$(date +%Y%m%d_%H%M%S)
              echo "âœ… Backup do banco de dados criado"
            fi
            
            # Fazer pull das mudanÃ§as
            echo "ğŸ“¥ Fazendo pull das mudanÃ§as..."
            git pull origin main || echo "âš ï¸ Erro ao fazer pull (continuando...)"
            
            # Instalar dependÃªncias (se necessÃ¡rio)
            echo "ğŸ“¦ Instalando dependÃªncias..."
            npm install
            
            # Rebuild do projeto
            echo "ğŸ”¨ Fazendo build da API..."
            npm run build --workspace=apps/api
            
            echo "ğŸ”¨ Fazendo build do Web..."
            npm run build --workspace=apps/web
            
            # Verificar se o banco de dados existe, se nÃ£o, criar
            if [ ! -f database.sqlite ]; then
              echo "ğŸ“Š Banco de dados nÃ£o encontrado. Criando..."
              npm run init:db || echo "âš ï¸ Erro ao criar banco (pode jÃ¡ existir)"
            fi
            
            # Reiniciar aplicaÃ§Ãµes PM2
            echo "ğŸ”„ Reiniciando aplicaÃ§Ãµes..."
            pm2 restart all
            
            # Salvar configuraÃ§Ã£o PM2
            pm2 save
            
            # Verificar status
            echo "ğŸ“Š Status das aplicaÃ§Ãµes:"
            pm2 status
            
            echo "âœ… Deploy concluÃ­do!"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "ğŸ” Verificando logs das aplicaÃ§Ãµes..."
            pm2 logs --lines 20 --nostream

