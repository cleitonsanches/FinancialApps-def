name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    # Permite deploy manual pelo GitHub Actions UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "‚ùå Erro: VPS_HOST secret n√£o est√° configurado!"
            echo "Por favor, configure os secrets no GitHub:"
            echo "  Settings > Secrets and variables > Actions"
            echo "  Adicione: VPS_HOST, VPS_USER, VPS_SSH_KEY"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "‚ùå Erro: VPS_USER secret n√£o est√° configurado!"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "‚ùå Erro: VPS_SSH_KEY secret n√£o est√° configurado!"
            exit 1
          fi
          echo "‚úÖ Todos os secrets est√£o configurados"

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build API
        run: npm run build --workspace=apps/api

      - name: Build Web
        run: npm run build --workspace=apps/web

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || '22' }}
          timeout: 300s
          script: |
            # Ir para o diret√≥rio do projeto
            cd /var/www/FinancialApps-def
            
            # Fazer backup do banco de dados ANTES do deploy
            # Procurar banco em todos os locais poss√≠veis
            DB_FOUND=""
            DB_BACKUP_DIR="backups"
            mkdir -p "$DB_BACKUP_DIR"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            # Verificar locais poss√≠veis (ordem de prioridade)
            for DB_LOC in "apps/api/database.sqlite" "database.sqlite" "apps/api/../database.sqlite"; do
              if [ -f "$DB_LOC" ]; then
                DB_SIZE=$(du -h "$DB_LOC" | cut -f1)
                TABLES=$(sqlite3 "$DB_LOC" ".tables" 2>/dev/null | wc -w)
                echo "‚úÖ Banco encontrado: $DB_LOC (Tamanho: $DB_SIZE, Tabelas: $TABLES)"
                
                # Fazer backup
                cp "$DB_LOC" "$DB_BACKUP_DIR/database.sqlite.backup.$TIMESTAMP"
                echo "‚úÖ Backup criado: $DB_BACKUP_DIR/database.sqlite.backup.$TIMESTAMP"
                
                DB_FOUND="$DB_LOC"
                break
              fi
            done
            
            if [ -z "$DB_FOUND" ]; then
              echo "‚ö†Ô∏è AVISO: Nenhum banco de dados encontrado. Ser√° criado um novo ap√≥s o deploy."
            fi
            
            # Limpar arquivos n√£o rastreados que podem causar conflito (como export/*.csv)
            echo "üßπ Limpando arquivos n√£o rastreados na pasta export/..."
            if [ -d "export" ]; then
              rm -rf export/*.csv export/*.txt 2>/dev/null || true
              echo "‚úÖ Arquivos CSV removidos da pasta export/"
            fi
            
            # Fazer pull das mudan√ßas (usando estrat√©gia para sobrescrever arquivos locais)
            echo "üì• Fazendo pull das mudan√ßas..."
            git fetch origin main
            git reset --hard origin/main || {
              echo "‚ö†Ô∏è Erro ao fazer reset. Tentando merge..."
              git merge -X theirs origin/main || echo "‚ö†Ô∏è Erro no merge (continuando...)"
            }
            
            # Instalar depend√™ncias (se necess√°rio)
            echo "üì¶ Instalando depend√™ncias..."
            npm install
            
            # Limpar builds e cache anteriores
            echo "üßπ Limpando builds e cache anteriores..."
            rm -rf apps/api/dist 2>/dev/null || true
            rm -rf apps/web/.next 2>/dev/null || true
            rm -rf apps/web/out 2>/dev/null || true
            rm -rf apps/web/.next/cache 2>/dev/null || true
            rm -rf node_modules/.cache 2>/dev/null || true
            echo "‚úÖ Cache limpo"
            
            # Rebuild do projeto
            echo "üî® Fazendo build da API..."
            npm run build --workspace=apps/api
            
            echo "üî® Fazendo build do Web (Next.js)..."
            cd apps/web
            npm run build
            cd ../..
            
            # Verificar se o build do Next.js foi criado
            if [ ! -d "apps/web/.next" ]; then
              echo "‚ùå ERRO: Build do Next.js n√£o foi criado!"
              exit 1
            fi
            echo "‚úÖ Build do Next.js conclu√≠do com sucesso"
            
            # Verificar se o banco de dados existe AP√ìS o pull
            # N√ÉO criar banco novo se j√° existe um em qualquer local
            DB_EXISTS=false
            
            # Verificar locais poss√≠veis
            for DB_LOC in "apps/api/database.sqlite" "database.sqlite"; do
              if [ -f "$DB_LOC" ]; then
                DB_SIZE=$(du -h "$DB_LOC" | cut -f1)
                TABLES=$(sqlite3 "$DB_LOC" ".tables" 2>/dev/null | wc -w)
                echo "‚úÖ Banco existe: $DB_LOC (Tamanho: $DB_SIZE, Tabelas: $TABLES)"
                DB_EXISTS=true
                break
              fi
            done
            
            # S√ì criar banco se realmente n√£o existir nenhum
            if [ "$DB_EXISTS" = false ]; then
              echo "üìä Nenhum banco encontrado. Criando novo banco..."
              npm run init:db --workspace=apps/api || echo "‚ö†Ô∏è Erro ao criar banco"
              echo "‚ö†Ô∏è ATEN√á√ÉO: Banco novo criado! Se voc√™ tinha dados, restaure do backup."
            else
              echo "‚úÖ Banco de dados preservado. N√£o foi necess√°rio criar novo banco."
            fi
            
            # Executar migra√ß√µes pendentes
            echo "üîÑ Executando migra√ß√µes..."
            npm run migrate:proposal-observacoes --workspace=apps/api || echo "‚ö†Ô∏è Migra√ß√£o pode j√° ter sido executada"
            
            # Parar aplica√ß√µes PM2 completamente antes de reiniciar
            echo "üõë Parando aplica√ß√µes PM2..."
            pm2 stop all 2>/dev/null || true
            pm2 delete all 2>/dev/null || true
            
            # Reiniciar aplica√ß√µes PM2 do zero
            echo "üîÑ Reiniciando aplica√ß√µes PM2..."
            if [ -f "ecosystem.config.js" ]; then
              pm2 start ecosystem.config.js
            else
              # Iniciar manualmente se n√£o houver ecosystem.config.js
              cd apps/api
              pm2 start npm --name "financial-app" -- start
              cd ../web
              pm2 start npm --name "financial-web" -- start
              cd ../..
            fi
            
            # Aguardar alguns segundos para garantir que os servi√ßos iniciaram
            echo "‚è≥ Aguardando servi√ßos iniciarem..."
            sleep 8
            
            # Salvar configura√ß√£o PM2
            pm2 save
            
            # Verificar status
            echo "üìä Status das aplica√ß√µes:"
            pm2 status
            
            # Verificar se os servi√ßos est√£o online
            echo "üîç Verificando sa√∫de dos servi√ßos..."
            pm2 list | grep -E "online|errored" || echo "‚ö†Ô∏è Verifique o status manualmente"
            
            echo "‚úÖ Deploy conclu√≠do!"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "üîç Verificando status final das aplica√ß√µes..."
            pm2 status
            
            echo ""
            echo "üîç Verificando logs das aplica√ß√µes (√∫ltimas 20 linhas)..."
            pm2 logs --lines 20 --nostream
            
            echo ""
            echo "‚úÖ Verifica√ß√£o conclu√≠da. Se houver erros, verifique os logs acima."

