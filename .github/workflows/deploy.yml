name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    # Permite deploy manual pelo GitHub Actions UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "‚ùå Erro: VPS_HOST secret n√£o est√° configurado!"
            echo "Por favor, configure os secrets no GitHub:"
            echo "  Settings > Secrets and variables > Actions"
            echo "  Adicione: VPS_HOST, VPS_USER, VPS_SSH_KEY"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "‚ùå Erro: VPS_USER secret n√£o est√° configurado!"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "‚ùå Erro: VPS_SSH_KEY secret n√£o est√° configurado!"
            exit 1
          fi
          echo "‚úÖ Todos os secrets est√£o configurados"

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build API
        run: |
          cd apps/api
          echo "üî® Iniciando build da API..."
          npm run build || {
            echo "‚ùå ERRO: Build falhou!"
            exit 1
          }
          echo "Verificando resultado do build..."
          
          # Verificar se main.js foi criado
          if [ ! -f "dist/main.js" ]; then
            echo "‚ùå ERRO: dist/main.js n√£o foi criado!"
            exit 1
          fi
          
          # Verificar se app.module.js foi criado (indica que os m√≥dulos foram compilados)
          if [ ! -f "dist/app.module.js" ]; then
            echo "‚ùå ERRO: dist/app.module.js n√£o foi criado - m√≥dulos n√£o foram compilados!"
            echo "Conte√∫do do diret√≥rio dist:"
            ls -la dist/ | head -20
            exit 1
          fi
          
          # Verificar se h√° m√≥dulos compilados
          MODULES_COUNT=$(find dist/modules -name "*.js" 2>/dev/null | wc -l || echo "0")
          if [ "$MODULES_COUNT" -eq 0 ]; then
            echo "‚ùå ERRO: Nenhum m√≥dulo foi compilado em dist/modules/"
            echo "Conte√∫do do diret√≥rio dist:"
            ls -la dist/ | head -30
            exit 1
          fi
          
          echo "‚úÖ Build da API conclu√≠do:"
          echo "   - main.js: $(du -h dist/main.js | cut -f1)"
          echo "   - app.module.js: $(du -h dist/app.module.js | cut -f1)"
          echo "   - M√≥dulos compilados: $MODULES_COUNT arquivos"

      - name: Build Web
        run: |
          cd apps/web
          echo "üî® Iniciando build do Web..."
          npm run build || {
            echo "‚ö†Ô∏è Build retornou c√≥digo de erro, mas vamos verificar o resultado..."
          }
          echo "Verificando resultado do build..."
          
          # Listar conte√∫do do diret√≥rio atual
          echo "Conte√∫do do diret√≥rio apps/web:"
          ls -la | head -20
          
          # Verificar se .next existe
          if [ -d ".next" ]; then
            echo "‚úÖ Diret√≥rio .next existe"
            echo "Conte√∫do do .next:"
            ls -la .next/ | head -20
            
            if [ -f ".next/BUILD_ID" ]; then
              echo "‚úÖ BUILD_ID encontrado: $(cat .next/BUILD_ID)"
            else
              echo "‚ö†Ô∏è AVISO: BUILD_ID n√£o encontrado, mas .next existe"
            fi
            
            # Verificar standalone
            if [ -f ".next/standalone/apps/web/server.js" ]; then
              echo "‚úÖ Modo standalone encontrado"
            else
              echo "‚ö†Ô∏è AVISO: Modo standalone n√£o encontrado (pode ser normal dependendo da configura√ß√£o)"
            fi
          else
            echo "‚ö†Ô∏è AVISO: Diret√≥rio .next n√£o encontrado ap√≥s build"
            echo "Verificando se h√° outros arquivos de build..."
            find . -name "*.next*" -o -name "out" -type d | head -10
          fi
          
          echo "‚úÖ Verifica√ß√£o do build do Web conclu√≠da (n√£o bloqueando deploy)"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || '22' }}
          timeout: 300s
          script: |
            # Ir para o diret√≥rio do projeto
            cd /var/www/FinancialApps-def
            
            # Fazer backup do banco de dados ANTES do deploy
            # Procurar banco em todos os locais poss√≠veis
            DB_FOUND=""
            DB_BACKUP_DIR="backups"
            mkdir -p "$DB_BACKUP_DIR"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            # Verificar locais poss√≠veis (ordem de prioridade)
            for DB_LOC in "apps/api/database.sqlite" "database.sqlite" "apps/api/../database.sqlite"; do
              if [ -f "$DB_LOC" ]; then
                DB_SIZE=$(du -h "$DB_LOC" | cut -f1)
                TABLES=$(sqlite3 "$DB_LOC" ".tables" 2>/dev/null | wc -w)
                echo "‚úÖ Banco encontrado: $DB_LOC (Tamanho: $DB_SIZE, Tabelas: $TABLES)"
                
                # Fazer backup
                cp "$DB_LOC" "$DB_BACKUP_DIR/database.sqlite.backup.$TIMESTAMP"
                echo "‚úÖ Backup criado: $DB_BACKUP_DIR/database.sqlite.backup.$TIMESTAMP"
                
                DB_FOUND="$DB_LOC"
                break
              fi
            done
            
            if [ -z "$DB_FOUND" ]; then
              echo "‚ö†Ô∏è AVISO: Nenhum banco de dados encontrado. Ser√° criado um novo ap√≥s o deploy."
            fi
            
            # Limpar arquivos n√£o rastreados que podem causar conflito (como export/*.csv)
            echo "üßπ Limpando arquivos n√£o rastreados na pasta export/..."
            if [ -d "export" ]; then
              rm -rf export/*.csv export/*.txt 2>/dev/null || true
              echo "‚úÖ Arquivos CSV removidos da pasta export/"
            fi
            
            # Fazer pull das mudan√ßas (usando estrat√©gia para sobrescrever arquivos locais)
            echo "üì• Fazendo pull das mudan√ßas..."
            git fetch origin main
            git reset --hard origin/main || {
              echo "‚ö†Ô∏è Erro ao fazer reset. Tentando merge..."
              git merge -X theirs origin/main || echo "‚ö†Ô∏è Erro no merge (continuando...)"
            }
            
            # Parar PM2 ANTES de limpar (para evitar conflitos)
            echo "üõë Parando PM2 antes do rebuild..."
            pm2 stop all 2>/dev/null || true
            pm2 delete all 2>/dev/null || true
            sleep 2
            
            # Limpar builds e cache anteriores COMPLETAMENTE
            echo "üßπ Limpando builds e cache anteriores..."
            rm -rf apps/api/dist 2>/dev/null || true
            rm -rf apps/web/.next 2>/dev/null || true
            rm -rf apps/web/out 2>/dev/null || true
            rm -rf apps/web/.next/cache 2>/dev/null || true
            rm -rf node_modules/.cache 2>/dev/null || true
            echo "‚úÖ Cache limpo completamente"
            
            # Instalar/atualizar depend√™ncias na RAIZ (workspace do npm)
            echo "üì¶ Instalando depend√™ncias na raiz (workspace)..."
            npm install --legacy-peer-deps || {
              echo "‚ùå ERRO: Falha ao instalar depend√™ncias na raiz!"
              echo "Tentando reinstalar limpo..."
              rm -rf node_modules package-lock.json
              npm install --legacy-peer-deps || {
                echo "‚ùå ERRO CR√çTICO: N√£o foi poss√≠vel instalar depend√™ncias!"
                exit 1
              }
            }
            echo "‚úÖ Depend√™ncias instaladas com sucesso"
            
            # Verificar se nest CLI est√° dispon√≠vel (deve estar em node_modules/.bin/nest ap√≥s instala√ß√£o)
            if [ ! -f "node_modules/.bin/nest" ] && [ ! -f "apps/api/node_modules/.bin/nest" ]; then
              echo "‚ö†Ô∏è NestJS CLI n√£o encontrado ap√≥s instala√ß√£o de depend√™ncias!"
              echo "Verificando estrutura de node_modules..."
              find . -name "nest" -type f 2>/dev/null | head -5
              echo "Tentando instalar @nestjs/cli globalmente..."
              npm install -g @nestjs/cli || {
                echo "‚ùå ERRO: N√£o foi poss√≠vel instalar @nestjs/cli!"
                exit 1
              }
            fi
            echo "‚úÖ NestJS CLI encontrado"
            
            # Rebuild do projeto - API usando workspace (da raiz)
            echo "üî® Fazendo build da API..."
            
            # Limpar build anterior novamente (garantir)
            rm -rf apps/api/dist 2>/dev/null || true
            
            # Executar build usando workspace (da raiz do projeto)
            echo "Executando: npm run build --workspace=apps/api"
            npm run build --workspace=apps/api 2>&1 | tee /tmp/api-build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
            
            # Verificar c√≥digo de sa√≠da
            if [ $BUILD_EXIT_CODE -ne 0 ]; then
              echo "‚ùå ERRO: Build da API falhou com c√≥digo $BUILD_EXIT_CODE"
              echo "=========================================="
              echo "√öLTIMAS 100 LINHAS DO LOG DE BUILD:"
              echo "=========================================="
              tail -100 /tmp/api-build.log
              echo "=========================================="
              exit 1
            fi
            
            # Verificar se main.js foi criado (da raiz do projeto)
            if [ ! -f "apps/api/dist/main.js" ]; then
              echo "‚ùå ERRO: apps/api/dist/main.js n√£o foi criado! Build da API falhou."
              echo "Conte√∫do do diret√≥rio apps/api/dist:"
              ls -la apps/api/dist/ 2>/dev/null || echo "Diret√≥rio apps/api/dist n√£o existe"
              echo ""
              echo "Log completo do build:"
              cat /tmp/api-build.log
              exit 1
            fi
            
            # Verificar se app.module.js foi criado
            if [ ! -f "apps/api/dist/app.module.js" ]; then
              echo "‚ùå ERRO: apps/api/dist/app.module.js n√£o foi criado - m√≥dulos n√£o foram compilados!"
              echo "Conte√∫do do diret√≥rio apps/api/dist:"
              ls -la apps/api/dist/ 2>/dev/null | head -30
              echo ""
              echo "Log completo do build:"
              cat /tmp/api-build.log
              exit 1
            fi
            
            # Verificar se h√° m√≥dulos compilados
            MODULES_COUNT=$(find apps/api/dist/modules -name "*.js" 2>/dev/null | wc -l || echo "0")
            if [ "$MODULES_COUNT" -eq 0 ]; then
              echo "‚ùå ERRO: Nenhum m√≥dulo foi compilado em apps/api/dist/modules/"
              echo "Conte√∫do do diret√≥rio apps/api/dist:"
              ls -la apps/api/dist/ 2>/dev/null | head -30
              echo ""
              echo "Log completo do build:"
              cat /tmp/api-build.log
              exit 1
            fi
            
            echo "‚úÖ Build da API conclu√≠do com sucesso:"
            echo "   - main.js: $(du -h apps/api/dist/main.js | cut -f1)"
            echo "   - app.module.js: $(du -h apps/api/dist/app.module.js | cut -f1)"
            echo "   - M√≥dulos compilados: $MODULES_COUNT arquivos"
            
            echo "üî® Fazendo build do Web (Next.js)..."
            
            # Limpar build anterior
            rm -rf apps/web/.next apps/web/out 2>/dev/null || true
            
            # Verificar se next est√° dispon√≠vel (j√° instalado via workspace na raiz)
            if [ ! -f "node_modules/.bin/next" ] && [ ! -f "apps/web/node_modules/.bin/next" ] && ! command -v next &> /dev/null; then
              echo "‚ö†Ô∏è Next.js CLI n√£o encontrado ap√≥s instala√ß√£o de depend√™ncias!"
              echo "Verificando estrutura de node_modules..."
              find . -name "next" -type f 2>/dev/null | head -5
              echo "‚ö†Ô∏è Continuando build mesmo assim (pode funcionar via workspace)"
            else
              echo "‚úÖ Next.js CLI encontrado"
            fi
            
            # Executar build usando workspace (da raiz do projeto)
            echo "Executando: npm run build --workspace=apps/web"
            npm run build --workspace=apps/web 2>&1 | tee /tmp/web-build.log
            BUILD_WEB_EXIT_CODE=${PIPESTATUS[0]}
            
            # Verificar c√≥digo de sa√≠da
            if [ $BUILD_WEB_EXIT_CODE -ne 0 ]; then
              echo "‚ùå ERRO: Build do Next.js falhou com c√≥digo $BUILD_WEB_EXIT_CODE"
              echo "=========================================="
              echo "√öLTIMAS 100 LINHAS DO LOG DE BUILD:"
              echo "=========================================="
              tail -100 /tmp/web-build.log
              echo "=========================================="
              exit 1
            fi
            
            echo "Verificando resultado do build do Next.js..."
            
            # Verificar se o build do Next.js foi criado
            if [ -d "apps/web/.next" ]; then
              echo "‚úÖ Diret√≥rio .next existe"
              
              # Verificar BUILD_ID
              if [ -f "apps/web/.next/BUILD_ID" ]; then
                BUILD_ID=$(cat apps/web/.next/BUILD_ID)
                echo "‚úÖ BUILD_ID encontrado: $BUILD_ID"
              else
                echo "‚ö†Ô∏è AVISO: BUILD_ID n√£o encontrado, mas .next existe"
              fi
              
              # Verificar standalone (pode n√£o existir mesmo com output: standalone se houver erro)
              if [ -f "apps/web/.next/standalone/apps/web/server.js" ]; then
                echo "‚úÖ Modo standalone encontrado e completo"
              else
                echo "‚ö†Ô∏è AVISO: Modo standalone n√£o encontrado"
                echo "Estrutura do .next:"
                ls -la apps/web/.next/ | head -20
                
                # Se n√£o est√° em standalone mas tem BUILD_ID, o build pode estar OK para modo padr√£o
                if [ -f "apps/web/.next/BUILD_ID" ]; then
                  echo "‚úÖ Build do Next.js conclu√≠do (modo padr√£o, sem standalone)"
                else
                  echo "‚ö†Ô∏è ATEN√á√ÉO: Nem standalone nem BUILD_ID encontrados"
                  echo "√öltimas 50 linhas do log de build:"
                  tail -50 /tmp/web-build.log 2>/dev/null || echo "Log n√£o dispon√≠vel"
                  # N√£o bloquear - pode funcionar mesmo assim
                fi
              fi
            else
              echo "‚ö†Ô∏è ATEN√á√ÉO: Diret√≥rio .next n√£o encontrado ap√≥s build"
              echo "Conte√∫do de apps/web:"
              ls -la apps/web/ | head -20
              echo ""
              echo "√öltimas 50 linhas do log de build:"
              tail -50 /tmp/web-build.log 2>/dev/null || echo "Log n√£o dispon√≠vel"
              echo ""
              echo "‚ö†Ô∏è Continuando deploy mesmo assim (PM2 pode precisar reconstruir)"
            fi
            
            # Verificar se o banco de dados existe AP√ìS o pull
            # N√ÉO criar banco novo se j√° existe um em qualquer local
            DB_EXISTS=false
            
            # Verificar locais poss√≠veis
            for DB_LOC in "apps/api/database.sqlite" "database.sqlite"; do
              if [ -f "$DB_LOC" ]; then
                DB_SIZE=$(du -h "$DB_LOC" | cut -f1)
                TABLES=$(sqlite3 "$DB_LOC" ".tables" 2>/dev/null | wc -w)
                echo "‚úÖ Banco existe: $DB_LOC (Tamanho: $DB_SIZE, Tabelas: $TABLES)"
                DB_EXISTS=true
                break
              fi
            done
            
            # S√ì criar banco se realmente n√£o existir nenhum
            if [ "$DB_EXISTS" = false ]; then
              echo "üìä Nenhum banco encontrado. Criando novo banco..."
              npm run init:db --workspace=apps/api || echo "‚ö†Ô∏è Erro ao criar banco"
              echo "‚ö†Ô∏è ATEN√á√ÉO: Banco novo criado! Se voc√™ tinha dados, restaure do backup."
            else
              echo "‚úÖ Banco de dados preservado. N√£o foi necess√°rio criar novo banco."
            fi
            
            # Executar migra√ß√µes pendentes
            echo "üîÑ Executando migra√ß√µes..."
            npm run migrate:proposal-observacoes --workspace=apps/api || echo "‚ö†Ô∏è Migra√ß√£o pode j√° ter sido executada"
            
            # PM2 j√° foi parado antes do rebuild, ent√£o s√≥ verificar builds agora
            echo "üîç Verifica√ß√£o final dos builds antes de iniciar PM2..."
            
            # Verificar API
            if [ ! -f "apps/api/dist/main.js" ]; then
              echo "‚ö†Ô∏è ATEN√á√ÉO: apps/api/dist/main.js n√£o existe!"
              echo "Verificando se dist foi criado:"
              ls -la apps/api/dist/ 2>/dev/null | head -20 || echo "Diret√≥rio dist n√£o existe"
              
              # Tentar fazer build novamente
              echo "üîÑ Tentando fazer build da API novamente..."
              cd apps/api
              npm run build 2>&1 | tail -50 || echo "Build falhou"
              cd ../..
              
              # Verificar novamente
              if [ ! -f "apps/api/dist/main.js" ]; then
                echo "‚ùå ERRO CR√çTICO: apps/api/dist/main.js ainda n√£o existe ap√≥s rebuild!"
                echo "Conte√∫do do diret√≥rio apps/api:"
                ls -la apps/api/ | head -30
                exit 1
              else
                echo "‚úÖ Build da API criado com sucesso no rebuild"
              fi
            else
              echo "‚úÖ apps/api/dist/main.js existe"
              
              # Verificar se m√≥dulos foram compilados
              MODULES_COUNT=$(find apps/api/dist/modules -name "*.js" 2>/dev/null | wc -l || echo "0")
              if [ "$MODULES_COUNT" -eq 0 ]; then
                echo "‚ö†Ô∏è ATEN√á√ÉO: Nenhum m√≥dulo compilado encontrado. Tentando rebuild..."
                cd apps/api
                npm run build 2>&1 | tail -50 || echo "Build falhou"
                cd ../..
              else
                echo "‚úÖ M√≥dulos compilados: $MODULES_COUNT arquivos"
              fi
            fi
            
            # Verificar Web (n√£o cr√≠tico, pode usar npm start)
            if [ -d "apps/web/.next" ]; then
              echo "‚úÖ apps/web/.next existe"
            else
              echo "‚ö†Ô∏è AVISO: apps/web/.next n√£o existe, mas PM2 pode usar npm start"
            fi
            
            # Reiniciar aplica√ß√µes PM2 do zero
            echo "üîÑ Reiniciando aplica√ß√µes PM2..."
            if [ -f "ecosystem.config.js" ]; then
              # Verificar se o standalone existe, sen√£o usar npm start
              if [ -f "apps/web/.next/standalone/apps/web/server.js" ]; then
                echo "  ‚úÖ Usando modo standalone do Next.js"
                pm2 start ecosystem.config.js
              else
                echo "  ‚ö†Ô∏è Standalone n√£o encontrado, usando npm start para web"
                # Iniciar API normalmente
                pm2 start ecosystem.config.js --only financial-api
                # Iniciar Web com npm start
                cd apps/web
                pm2 start npm --name "financial-web" -- start
                cd ../..
              fi
            else
              # Iniciar manualmente se n√£o houver ecosystem.config.js
              cd apps/api
              pm2 start npm --name "financial-app" -- start
              cd ../web
              pm2 start npm --name "financial-web" -- start
              cd ../..
            fi
            
            # Aguardar alguns segundos para garantir que os servi√ßos iniciaram
            echo "‚è≥ Aguardando servi√ßos iniciarem..."
            sleep 8
            
            # Salvar configura√ß√£o PM2
            pm2 save
            
            # Verificar status
            echo "üìä Status das aplica√ß√µes:"
            pm2 status
            
            # Verificar se os servi√ßos est√£o online
            echo "üîç Verificando sa√∫de dos servi√ßos..."
            pm2 list | grep -E "online|errored" || echo "‚ö†Ô∏è Verifique o status manualmente"
            
            echo "‚úÖ Deploy conclu√≠do!"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "üîç Verificando status final das aplica√ß√µes..."
            pm2 status
            
            echo ""
            echo "üîç Verificando logs das aplica√ß√µes (√∫ltimas 20 linhas)..."
            pm2 logs --lines 20 --nostream
            
            echo ""
            echo "‚úÖ Verifica√ß√£o conclu√≠da. Se houver erros, verifique os logs acima."

