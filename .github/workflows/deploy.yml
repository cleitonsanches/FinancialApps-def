name: Deploy to VPS

on:
  push:
    branches:
      - main
    # Evitar deploy autom√°tico em cada push, apenas quando explicitamente necess√°rio
    # Para ativar: descomente as linhas acima e comente o workflow_dispatch abaixo
  workflow_dispatch:
    # Permite deploy manual pelo GitHub Actions UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "‚ùå Erro: VPS_HOST secret n√£o est√° configurado!"
            echo "Por favor, configure os secrets no GitHub:"
            echo "  Settings > Secrets and variables > Actions"
            echo "  Adicione: VPS_HOST, VPS_USER, VPS_SSH_KEY"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "‚ùå Erro: VPS_USER secret n√£o est√° configurado!"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "‚ùå Erro: VPS_SSH_KEY secret n√£o est√° configurado!"
            exit 1
          fi
          echo "‚úÖ Todos os secrets est√£o configurados"

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build API
        run: npm run build --workspace=apps/api

      - name: Build Web
        run: npm run build --workspace=apps/web

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || '22' }}
          timeout: 300s
          script: |
            # Ir para o diret√≥rio do projeto
            cd /var/www/FinancialApps-def
            
            # Fazer backup do banco de dados antes do deploy
            if [ -f database.sqlite ]; then
              cp database.sqlite database.sqlite.backup.$(date +%Y%m%d_%H%M%S)
              echo "‚úÖ Backup do banco de dados criado"
            fi
            
            # Fazer pull das mudan√ßas
            echo "üì• Fazendo pull das mudan√ßas..."
            git pull origin main || echo "‚ö†Ô∏è Erro ao fazer pull (continuando...)"
            
            # Instalar depend√™ncias (se necess√°rio)
            echo "üì¶ Instalando depend√™ncias..."
            npm install
            
            # Rebuild do projeto
            echo "üî® Fazendo build da API..."
            npm run build --workspace=apps/api
            
            echo "üî® Fazendo build do Web..."
            npm run build --workspace=apps/web
            
            # Verificar se o banco de dados existe, se n√£o, criar
            if [ ! -f database.sqlite ]; then
              echo "üìä Banco de dados n√£o encontrado. Criando..."
              npm run init:db || echo "‚ö†Ô∏è Erro ao criar banco (pode j√° existir)"
            fi
            
            # Reiniciar aplica√ß√µes PM2
            echo "üîÑ Reiniciando aplica√ß√µes..."
            pm2 restart all
            
            # Salvar configura√ß√£o PM2
            pm2 save
            
            # Verificar status
            echo "üìä Status das aplica√ß√µes:"
            pm2 status
            
            echo "‚úÖ Deploy conclu√≠do!"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "üîç Verificando logs das aplica√ß√µes..."
            pm2 logs --lines 20 --nostream

